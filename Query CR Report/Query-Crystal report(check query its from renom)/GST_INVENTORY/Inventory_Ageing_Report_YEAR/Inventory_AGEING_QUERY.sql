USE [Renom_Live]
GO

/****** Object:  StoredProcedure [dbo].[PTS_ESYS_STOCK_AGENING1]    Script Date: 03/05/2020 14:30:17 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[PTS_ESYS_STOCK_AGENING1]

@ToDate  DATE
,@Location nvarchar(100)
as
Begin

;with PENDING_STOCK as(
SELECT 
ITEMCODE
,sum(CASE when inm.DocDate <= @ToDate then isnull(inqty, 0)- isnull(OutQty,0) else 0 end) as 'PS DEBIT'
,sum(CASE when inm.DocDate <= @ToDate then isnull(transvalue, 0) end) as 'PS DEBIT Price'       
 
FROM OINM INM
LEFT OUTER JOIN OWHS OW ON INM.WAREHOUSE = OW.WHSCODE
LEFT OUTER JOIN OLCT OL ON OW.LOCATION = OL.CODE
WHERE OL.Location = @Location 
GROUP BY ITEMCODE )
-----------------------------------------**********lESS_THAN 30*************-----------------------------------------------------------------
, LESS_THAN_30 AS(
SELECT INM.ITEMCODE
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 30 AND INM.DOCDATE <= @ToDate THEN  isnull(inqty, 0) else 0 end )'LT30 DEBIT'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 30 AND INM.DOCDATE <= @ToDate AND INM.TransValue > 0 
          THEN  isnull(TransValue, 0) else 0 end )'LT30 DEBIT VALUE'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 30 AND INM.DOCDATE <= @ToDate THEN  isnull(outqty, 0) else 0 end )'LT30 OUT'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 30 AND INM.DOCDATE <= @ToDate AND INM.TransValue < 0 
          THEN  isnull(TransValue, 0) else 0 end )'LT30 OUT VALUE'

FROM OINM INM
INNER JOIN PENDING_STOCK AS P1 ON INM.ITEMCODE = P1.ITEMCODE
LEFT OUTER JOIN OWHS OW ON INM.WAREHOUSE = OW.WHSCODE
LEFT OUTER JOIN OLCT OL ON OW.LOCATION = OL.CODE
WHERE OL.Location = @Location 
GROUP BY INM.ITEMCODE
)
-----------------------------------------**********bETWEEN 30 AND 60*************-----------------------------------------------------------------
, BETWEEN_30_60 AS(
SELECT INM.ITEMCODE
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate)  >=  30 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 60 AND INM.DOCDATE <= @ToDate THEN  isnull(inqty, 0) else 0 end )'BT3060 DEBIT'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate)  >=  30 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 60 AND INM.DOCDATE <= @ToDate AND INM.TransValue > 0 
          THEN  isnull(TransValue, 0) else 0 end )'BT3060 DEBIT VALUE'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate)  >=  30 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 60 AND INM.DOCDATE <= @ToDate THEN  isnull(outqty, 0) else 0 end )'BT3060 Out'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate)  >=  30 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 60 AND INM.DOCDATE <= @ToDate AND INM.TransValue < 0
          THEN  isnull(TransValue, 0) else 0 end )'BT3060 Out VALUE'
FROM OINM INM
INNER JOIN PENDING_STOCK AS P1 ON INM.ITEMCODE = P1.ITEMCODE
LEFT OUTER JOIN OWHS OW ON INM.WAREHOUSE = OW.WHSCODE
LEFT OUTER JOIN OLCT OL ON OW.LOCATION = OL.CODE
WHERE OL.Location = @Location 
GROUP BY INM.ITEMCODE
)
-----------------------------------------**********bETWEEN 60 AND 90*************-----------------------------------------------------------------
, BETWEEN_60_90 AS(
SELECT INM.ITEMCODE
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >=  60 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 90 AND INM.DOCDATE <= @ToDate THEN  isnull(inqty, 0) else 0 end )'BT6090 DEBIT'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >=  60 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 90 AND INM.DOCDATE <= @ToDate AND INM.TransValue > 0 
          THEN  isnull(TransValue, 0) else 0 end )'BT6090 DEBIT VALUE'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >=  60 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 90 AND INM.DOCDATE <= @ToDate THEN  isnull(outQTY, 0) else 0 end )'BT6090 out'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >=  60 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 90 AND INM.DOCDATE <= @ToDate AND INM.TransValue < 0
          THEN  isnull(TransValue, 0) else 0 end )'BT6090 out VALUE'
FROM OINM INM
INNER JOIN PENDING_STOCK AS P1 ON INM.ITEMCODE = P1.ITEMCODE
LEFT OUTER JOIN OWHS OW ON INM.WAREHOUSE = OW.WHSCODE
LEFT OUTER JOIN OLCT OL ON OW.LOCATION = OL.CODE
WHERE OL.Location = @Location 
GROUP BY INM.ITEMCODE
)
-------------------------------------------**********GREATER_THAN 90*************-----------------------------------------------------------------
--, GREATER_THAN_90 AS(
--SELECT INM.ITEMCODE
--,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 90 AND INM.DOCDATE <= @ToDate THEN  isnull(inqty, 0) else 0 end )'GT90 DEBIT'
--,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 90 AND INM.DOCDATE <= @ToDate AND INM.TransValue > 0 
--          THEN  isnull(TransValue, 0) else 0 end )'GT90 DEBIT VALUE'
--,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 90 AND INM.DOCDATE <= @ToDate THEN  isnull(outqty, 0) else 0 end )'GT90 out'
--,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 90 AND INM.DOCDATE <= @ToDate AND INM.TransValue < 0 
--          THEN  isnull(TransValue, 0) else 0 end )'GT90 out VALUE'

--FROM OINM INM
--INNER JOIN PENDING_STOCK AS P1 ON INM.ITEMCODE = P1.ITEMCODE
--LEFT OUTER JOIN OWHS OW ON INM.WAREHOUSE = OW.WHSCODE
--LEFT OUTER JOIN OLCT OL ON OW.LOCATION = OL.CODE
--WHERE OL.Location = @Location 
--GROUP BY INM.ITEMCODE
--)

-----------------------------------------**********GREATER_THAN 90365*************-----------------------------------------------------------------
, GREATER_THAN_90 AS(
SELECT INM.ITEMCODE
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 90 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 365 AND INM.DOCDATE <= @ToDate THEN  isnull(inqty, 0) else 0 end )'GT90 DEBIT'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 90 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 365 AND INM.DOCDATE <= @ToDate AND INM.TransValue > 0 
          THEN  isnull(TransValue, 0) else 0 end )'GT90 DEBIT VALUE'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 90 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 365 AND INM.DOCDATE <= @ToDate THEN  isnull(outqty, 0) else 0 end )'GT90 out'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 90 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 365 AND INM.DOCDATE <= @ToDate AND INM.TransValue < 0 
          THEN  isnull(TransValue, 0) else 0 end )'GT90 out VALUE'

FROM OINM INM
INNER JOIN PENDING_STOCK AS P1 ON INM.ITEMCODE = P1.ITEMCODE
LEFT OUTER JOIN OWHS OW ON INM.WAREHOUSE = OW.WHSCODE
LEFT OUTER JOIN OLCT OL ON OW.LOCATION = OL.CODE
WHERE OL.Location = @Location 
GROUP BY INM.ITEMCODE
)
-----------------------------------------**********GREATER_THAN 365730*************-----------------------------------------------------------------

, GREATER_THAN_365 AS(
SELECT INM.ITEMCODE
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 365 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 730 AND INM.DOCDATE <= @ToDate THEN  isnull(inqty, 0) else 0 end )'GT365730 DEBIT'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 365 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 730 AND INM.DOCDATE <= @ToDate AND INM.TransValue > 0 
          THEN  isnull(TransValue, 0) else 0 end )'GT365730 DEBIT VALUE'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 365 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 730  AND INM.DOCDATE <= @ToDate THEN  isnull(outqty, 0) else 0 end )'GT365730 out'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 365 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 730  AND INM.DOCDATE <= @ToDate AND INM.TransValue < 0 
          THEN  isnull(TransValue, 0) else 0 end )'GT365730 out VALUE'

FROM OINM INM
INNER JOIN PENDING_STOCK AS P1 ON INM.ITEMCODE = P1.ITEMCODE
LEFT OUTER JOIN OWHS OW ON INM.WAREHOUSE = OW.WHSCODE
LEFT OUTER JOIN OLCT OL ON OW.LOCATION = OL.CODE
WHERE OL.Location = @Location 
GROUP BY INM.ITEMCODE
)

--------------------------------**************************GREATER THAN 1095 days********************----------------------
, BETWEEN_730_1095 AS(
SELECT INM.ITEMCODE
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 730 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 1095 AND INM.DOCDATE <= @ToDate THEN  isnull(inqty, 0) else 0 end )'GT7301095 DEBIT'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 730 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 1095 AND INM.DOCDATE <= @ToDate AND INM.TransValue > 0 
          THEN  isnull(TransValue, 0) else 0 end )'GT7301095 DEBIT VALUE'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 730 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 1095 AND INM.DOCDATE <= @ToDate THEN  isnull(outqty, 0) else 0 end )'GT7301095 out'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 730 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 1095 AND INM.DOCDATE <= @ToDate AND INM.TransValue < 0 
          THEN  isnull(TransValue, 0) else 0 end )'GT7301095 out VALUE'

FROM OINM INM
INNER JOIN PENDING_STOCK AS P1 ON INM.ITEMCODE = P1.ITEMCODE
LEFT OUTER JOIN OWHS OW ON INM.WAREHOUSE = OW.WHSCODE
LEFT OUTER JOIN OLCT OL ON OW.LOCATION = OL.CODE
WHERE OL.Location = @Location 
GROUP BY INM.ITEMCODE
)

----------------------------------------------------------------BETWEEN 1095 to 1460 days-------------------------------------------
, BETWEEN_1095_1460 AS(
SELECT INM.ITEMCODE
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 1095 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 1460 AND INM.DOCDATE <= @ToDate THEN  isnull(inqty, 0) else 0 end )'GT10951460 DEBIT'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 1095 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 1460 AND INM.DOCDATE <= @ToDate AND INM.TransValue > 0 
          THEN  isnull(TransValue, 0) else 0 end )'GT10951460 DEBIT VALUE'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 1095 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 1460 AND INM.DOCDATE <= @ToDate THEN  isnull(outqty, 0) else 0 end )'GT10951460 out'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 1095 AND DATEDIFF(DAY , INM.DOCDATE ,@ToDate) < 1460 AND INM.DOCDATE <= @ToDate AND INM.TransValue < 0 
          THEN  isnull(TransValue, 0) else 0 end )'GT10951460 out VALUE'

FROM OINM INM
INNER JOIN PENDING_STOCK AS P1 ON INM.ITEMCODE = P1.ITEMCODE
LEFT OUTER JOIN OWHS OW ON INM.WAREHOUSE = OW.WHSCODE
LEFT OUTER JOIN OLCT OL ON OW.LOCATION = OL.CODE
WHERE OL.Location = @Location 
GROUP BY INM.ITEMCODE
)
---------------------------------********************GERETAER Than 1460 days*************************-----------------------------
, GREATER_THAN_1460 AS(
SELECT INM.ITEMCODE
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 1460 AND INM.DOCDATE <= @ToDate THEN  isnull(inqty, 0) else 0 end )'GT1460 DEBIT'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 1460 AND INM.DOCDATE <= @ToDate AND INM.TransValue > 0 
          THEN  isnull(TransValue, 0) else 0 end )'GT1460 DEBIT VALUE'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 1460 AND INM.DOCDATE <= @ToDate THEN  isnull(outqty, 0) else 0 end )'GT1460 out'
,SUM(CASE WHEN DATEDIFF(DAY , INM.DOCDATE ,@ToDate) >= 1460 AND INM.DOCDATE <= @ToDate AND INM.TransValue < 0 
          THEN  isnull(TransValue, 0) else 0 end )'GT1460 out VALUE'

FROM OINM INM
INNER JOIN PENDING_STOCK AS P1 ON INM.ITEMCODE = P1.ITEMCODE
LEFT OUTER JOIN OWHS OW ON INM.WAREHOUSE = OW.WHSCODE
LEFT OUTER JOIN OLCT OL ON OW.LOCATION = OL.CODE
WHERE OL.Location = @Location 
GROUP BY INM.ITEMCODE
)

--------------------------------------------**********************--------------------------------------------
, OUT_QTY AS(
select 
T1.ITEMCODE,
T2.[LT30 OUT]+ T3.[BT3060 OUT]+T4.[BT6090 OUT]+T5.[GT90 OUT]+T6.[GT365730 OUT]+T7.[GT7301095 OUT]+T8.[GT10951460 OUT]+T9.[GT1460 OUT] 'Out'
,T2.[LT30 OUT VALUE]+ T3.[BT3060 OUT VALUE]+T4.[BT6090 OUT VALUE]+T5.[GT90 OUT VALUE]+T6.[GT365730 OUT VALUE]+T7.[GT7301095 OUT VALUE]+T8.[GT10951460 OUT VALUE]+T9.[GT1460 OUT VALUE] 'Out VALUE'

 FROM
 PENDING_STOCK AS T1 
 INNER JOIN  LESS_THAN_30 AS T2 ON T1.ITEMCODE = T2.ITEMCODE 
 INNER JOIN  BETWEEN_30_60  AS T3 ON T1.ITEMCODE = T3.ITEMCODE
 INNER JOIN  BETWEEN_60_90  AS T4 ON T1.ITEMCODE = T4.ITEMCODE
 INNER JOIN  GREATER_THAN_90 AS T5 ON T1.ITEMCODE = T5.ITEMCODE
 INNER JOIN  GREATER_THAN_365 AS T6 ON T1.ITEMCODE = T6.ITEMCODE
 INNER JOIN  BETWEEN_730_1095 AS T7 ON T1.ITEMCODE = T7.ITEMCODE 
 INNER JOIN BETWEEN_1095_1460 AS T8 ON T1.ITEMCODE = T8.ITEMCODE 
 INNER JOIN  GREATER_THAN_1460 AS T9 ON T1.ITEMCODE = T9.ITEMCODE 
 WHERE T1.[PS DEBIT]<> 0)
--------------------------------------------**********************--------------------------------------------
SELECT 
T7.ITEMCODE 'Particulars'
,T7.ItemName 'Particular Description '
,T1.[PS DEBIT Price]/T1.[PS DEBIT] 'Unit Price'
,T1.[PS DEBIT] 'Stock Total'
,T1.[PS DEBIT Price] 'Stock Total Value'

,CASE WHEN (T3.[BT3060 DEBIT] + T4.[BT6090 DEBIT] + T5.[GT90 DEBIT]+T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) >= 0 THEN T2.[LT30 DEBIT]
      WHEN (T3.[BT3060 DEBIT] + T4.[BT6090 DEBIT] + T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) < 0 AND (T2.[LT30 DEBIT] + T3.[BT3060 DEBIT] + T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0
      THEN (T2.[LT30 DEBIT] + T3.[BT3060 DEBIT] + T4.[BT6090 DEBIT] +T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END 'Stock 30 days'
      
,round((CASE WHEN (T3.[BT3060 DEBIT] + T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) >= 0 THEN T2.[LT30 DEBIT]
      WHEN (T3.[BT3060 DEBIT] + T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) < 0 AND (T2.[LT30 DEBIT]+ T3.[BT3060 DEBIT] + T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0
      THEN (T2.[LT30 DEBIT] + T3.[BT3060 DEBIT] + T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END) * (T1.[PS DEBIT Price]/T1.[PS DEBIT]),2) 'Stock 30 days Value'
          
,CASE WHEN (T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) >= 0 THEN T3.[BT3060 DEBIT]
      WHEN (T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) < 0 AND (T3.[BT3060 DEBIT] + T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0
      THEN (T3.[BT3060 DEBIT] + T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END 'Stock 30 to 60 days'
      
,round((CASE WHEN (T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) >= 0 THEN T3.[BT3060 DEBIT]
      WHEN (T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) < 0 AND (T3.[BT3060 DEBIT] + T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0
      THEN (T3.[BT3060 DEBIT] + T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END )* (T1.[PS DEBIT Price]/T1.[PS DEBIT]),2) 'Stock 30 to 60 days Value'  
           
,CASE WHEN  (T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) >= 0 THEN T4.[BT6090 DEBIT]
      WHEN  (T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) < 0 AND  (T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0 THEN (T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END '60 to 90 days'

,round((CASE WHEN (T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) >= 0 THEN round(T4.[BT6090 DEBIT],2)
      WHEN  (T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) < 0 AND  (T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0 THEN (T4.[BT6090 DEBIT] +  T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END)* (T1.[PS DEBIT Price]/T1.[PS DEBIT]),2) '60 to 90 days Value' 
   
,CASE WHEN  (T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) >= 0 THEN T5.[GT90 DEBIT]
      WHEN  (T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) < 0 AND  (T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0 THEN (T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END 'Stock 90 to 365 days'

,round((CASE WHEN (T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) >= 0 THEN T5.[GT90 DEBIT]
      WHEN  (T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) < 0 AND  (T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0 THEN (T5.[GT90 DEBIT] +T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END) * (T1.[PS DEBIT Price]/T1.[PS DEBIT]),2) 'Stock 90 to 365 days Value'   
   
 ,CASE WHEN  (T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) >= 0 THEN T8.[GT365730 DEBIT]
      WHEN  (T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) < 0 AND  (T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0 THEN (T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END 'Stock 365 to 730 days'

,round((CASE WHEN (T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) >= 0 THEN round(T8.[GT365730 DEBIT],2)
      WHEN  (T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) < 0 AND  (T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0 THEN (T8.[GT365730 DEBIT]+T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END)* (T1.[PS DEBIT Price]/T1.[PS DEBIT]),2) 'Stock 365 to 730 days Values'     
 
,CASE WHEN  (T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) >= 0 THEN round(T9.[GT7301095 DEBIT],2)
      WHEN  ((T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out))) < 0 AND  (T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0 THEN (T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END 'Stock 730 to 1095 days'

,round((CASE WHEN (T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) >= 0 THEN round(T9.[GT7301095 DEBIT],2)
      WHEN  ((T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out))) < 0 AND  (T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0 THEN (T9.[GT7301095 DEBIT]+T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END)* (T1.[PS DEBIT Price]/T1.[PS DEBIT]),2) 'Stock 730 to 1095 days Values'  
      
 ,CASE WHEN  (T11.[GT1460 DEBIT]- Out) >= 0 THEN T10.[GT10951460 DEBIT]
      WHEN   (T11.[GT1460 DEBIT]- Out) < 0 AND  (T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0 THEN (T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END 'Stock 1095 to 1460 days'

,round((CASE WHEN  (T11.[GT1460 DEBIT]- Out) >= 0 THEN T10.[GT10951460 DEBIT]
      WHEN   (T11.[GT1460 DEBIT]- Out) < 0 AND  (T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) > 0 THEN (T10.[GT10951460 DEBIT]+(T11.[GT1460 DEBIT]- Out)) ELSE 0 END)* (T1.[PS DEBIT Price]/T1.[PS DEBIT]),2) 'Stock 1095 to 1460 days Values'       
   
 ,CASE WHEN (T11.[GT1460 DEBIT]- Out) >= 0 THEN (T11.[GT1460 DEBIT] - Out) ELSE 0 END 'Stock  GT 1460 days '

,round((CASE WHEN (T11.[GT1460 DEBIT] - Out) >= 0 THEN (T11.[GT1460 DEBIT] - Out) ELSE 0 END)* (T1.[PS DEBIT Price]/T1.[PS DEBIT]),2) 'Stock  GT 1460 days Value'



 FROM
 PENDING_STOCK AS T1 
 INNER JOIN  LESS_THAN_30 AS T2 ON T1.ITEMCODE = T2.ITEMCODE 
 INNER JOIN  BETWEEN_30_60  AS T3 ON T1.ITEMCODE = T3.ITEMCODE
 INNER JOIN  BETWEEN_60_90  AS T4 ON T1.ITEMCODE = T4.ITEMCODE
 INNER JOIN  GREATER_THAN_90 AS T5 ON T1.ITEMCODE = T5.ITEMCODE 
 INNER JOIN  GREATER_THAN_365 AS T8 ON T1.ITEMCODE = T8.ITEMCODE 
 INNER JOIN  BETWEEN_730_1095 AS T9 ON T1.ITEMCODE = T9.ITEMCODE 
 INNER JOIN  BETWEEN_1095_1460 AS T10 ON T1.ITEMCODE = T10.ITEMCODE 
 INNER JOIN  GREATER_THAN_1460  AS T11 ON T1.ITEMCODE = T11.ITEMCODE    
 INNER JOIN  OUT_QTY AS T6 ON  T1.ITEMCODE = T6.ITEMCODE 
 INNER JOIN  OITM AS T7 ON T1.ITEMCODE = T7.ITEMCODE 
 WHERE T1.[PS DEBIT]<> 0 and T1.[PS DEBIT] > 0
 end 


GO


